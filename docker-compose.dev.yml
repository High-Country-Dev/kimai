services:
  kimai:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
      args:
        BASE: apache
        KIMAI: main
        TIMEZONE: America/New_York
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      # Database connection - Using AWS RDS MySQL
      DATABASE_URL: ${DATABASE_URL}

      # Initial admin user (created on first run)
      ADMINMAIL: ${ADMINMAIL:-admin@example.com}
      ADMINPASS: ${ADMINPASS:-changemeonlogin}

      # Application settings
      APP_SECRET: ${APP_SECRET}
      APP_ENV: ${APP_ENV:-dev}
      TRUSTED_HOSTS: ${TRUSTED_HOSTS:-localhost,127.0.0.1}

      # Email settings (optional, can be configured later)
      MAILER_FROM: ${MAILER_FROM:-kimai@example.com}
      MAILER_URL: ${MAILER_URL:-null://null}

      # Webhook settings (optional)
      WEBHOOK_URL: ${WEBHOOK_URL:-}
      WEBHOOK_SECRET: ${WEBHOOK_SECRET:-}

      # Notion integration (optional)
      NOTION_API_KEY: ${NOTION_API_KEY:-}
      NOTION_PROJECT_DATABASE_ID: ${NOTION_PROJECT_DATABASE_ID:-}
      NOTION_TIME_ENTRY_DATABASE_ID: ${NOTION_TIME_ENTRY_DATABASE_ID:-}
      NOTION_TASK_DATABASE_ID: ${NOTION_TASK_DATABASE_ID:-}
      NOTION_WORKSPACE: ${NOTION_WORKSPACE:-}

      # Development settings
      memory_limit: ${MEMORY_LIMIT:-512M}
    volumes:
      # Mount your local code for development
      - ./composer.json:/opt/kimai/composer.json
      - ./composer.lock:/opt/kimai/composer.lock
      - ./var/plugins:/opt/kimai/var/plugins
      - ./var/packages:/opt/kimai/var/packages
      # Mount templates for live editing
      - ./templates:/opt/kimai/templates

      # Persist Kimai data (logs, plugins, etc.)
      - kimai_dev_data:/opt/kimai/var

volumes:
  kimai_dev_data:
